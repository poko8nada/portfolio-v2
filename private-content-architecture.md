# 非公開コンテンツ共有用構成メモ

## はじめに

このドキュメントは、ポートフォリオサイトで関係者向けに非公開コンテンツ（レジュメなど）を安全に共有するための**理想的なアーキテクチャ**を記述したものです。現状の実装とは一部異なる点があり、今後の改修タスクも兼ねています。

## 背景と目的

- 一部の関係者にだけMarkdown形式の資料と画像を共有したい
- 現状はローカルにGit管理下のmdと画像を置き、ビルド時にバンドルしてBasic認証ページで公開している
- コンテンツの更新のたびにデプロイが必要であり、コンテンツとコードの分離ができていない
- 画像の直リンクや保存もできれば防ぎたい

## 現状の構成 (2025/07/26時点)

- **対象ページ**: `/resume`
- **認証**: Next.js Middleware (`src/middleware.ts`) によるBasic認証
- **コンテンツ**: ローカルのMarkdownファイル (`src/content/resume/**/*.md`) を、ビルドスクリプト (`scripts/prepare-resume.js`) を使って結合・処理し、アプリケーションにバンドル。
- **画像**: ローカルの画像ファイル (`src/content/resume/images/*`) を直接参照。`draggable="false"` のみ実装済み。

## 理想の構成案

### 保存・バージョン管理

- **保存先**: Markdown・画像はすべてCloudflare R2に保存する。
- **バージョン管理**: ファイル名にタイムスタンプを付与することで、簡易的なバージョン管理を実現する。
  - 命名規則: `[元のファイル名]_[YYYYMMDDHHMMSS].[拡張子]` (例: `resume_20250726103000.md`)
  - アップロードは常に新しいタイムスタンプでの「追加」とし、既存ファイルの上書きは行わない。
- **ロールバック**: 誤ったファイルをアップロードした場合、そのファイルをR2から削除するだけで、APIは自動的に一つ前のバージョンを最新として配信する。

### 公開方法

- **動的取得**: Next.jsのAPI Routeが、R2から最新バージョンのコンテンツを動的に取得して配信する。
  - APIはR2内のファイルをプレフィックスで検索し、タイムスタンプが最も新しいものを「最新」と判断する。
- **認証**: ページ (`/resume`) とAPI (`/api/resume/*`, `/api/proxy-image`) の両方を、Next.js MiddlewareによるBasic認証で保護する。

### 画像表示の扱い

- **プロキシ経由**: 画像は `/api/proxy-image` というAPI経由で配信する。
- **アクセス制御**: プロキシAPIはRefererヘッダをチェックし、自サイトからのリクエストのみを許可することで、画像の直リンクを防ぐ。
- **ダウンロード抑止**: `<img>` タグに `draggable="false"` と `onContextMenu={e => e.preventDefault()}` を設定し、簡易的な保存抑止を行う。

---

## R2移行に向けた実装タスク

### 1. R2バケットの準備と設定
- [x] `wrangler r2 bucket create portfolio-resume-assets` でプライベートなR2バケットを作成済み。
- [x] `wrangler.jsonc` にR2バケットのバインディング (`PORTFOLIO_ASSETS`) を設定済み。

### 2. コンテンツ取得APIの実装 (バージョン管理対応)

**実装ファイル:** `src/app/api/resume/[slug]/route.ts`

- [x] `R2.list()` を使用して、指定された `slug` のプレフィックスを持つファイルのリストを取得する。
- [x] ファイルリストをタイムスタンプ部分で降順ソートし、最新バージョンのファイルキーを特定する。
- [x] 最新のファイルを取得し、その内容をレスポンスとして返す。
- [x] 開発環境 (`pnpm dev`) では、ローカルの `src/content/resume/[slug].md` を直接読み込むフォールバック処理を実装する。

### 3. 画像プロキシAPIの実装 (バージョン管理対応)

**実装ファイル:** `src/app/api/proxy-image/route.ts`

- [x] コンテンツ取得APIと同様に、`R2.list()` を使って最新バージョンの画像を取得するロジックを実装する。
- [x] Refererヘッダによるアクセス制限を維持する。
- [x] 開発環境では、ローカルの `src/content/resume/images/` から画像を読み込むフォールバック処理を実装する。

### 4. フロントエンドのリファクタリング

- [ ] `src/lib/resume.ts`: ローカルimportを削除し、内部API (`/api/resume/[slug]`) 経由でコンテンツを取得するように変更する。
- [ ] `src/app/resume/page.tsx`: `<img>` タグの `src` をプロキシAPI経由に変更し、`onContextMenu` イベントハンドラを追加する。
- [ ] `src/components/markdown-for-resume.tsx`: Markdown内の相対パス画像もプロキシ経由で表示されるように修正する。

### 5. コンテンツ移行とアップロードスクリプトの作成

- [ ] `scripts/upload-resume.js` を新規作成する。このスクリプトは、`src/content/resume` 内のファイルを、タイムスタンプを付与してR2にアップロードする。
- [ ] 作成したスクリプトを実行し、初期コンテンツをR2にアップロードする。

### 6. 旧コンテンツの削除とGit管理からの除外

- [ ] `src/content/` ディレクトリを削除する。
- [ ] `.gitignore` に `src/content/` を追加する。
- [ ] 不要になった `scripts/prepare-resume.js` を削除する。

### 7. middlewareの更新

- [x] Basic認証の対象パスに `/api/resume/*` と `/api/proxy-image` を追加済み。

### 8. デプロイと動作確認

- [ ] `/resume` ページで、R2から取得した最新のコンテンツが表示されるか。
- [ ] 画像がプロキシ経由で表示され、右クリック保存ができないようになっているか。
- [ ] R2に新しいバージョンのファイルをアップロード後、ページをリロードすると内容が更新されるか。
- [ ] R2から最新ファイルを削除後、ページをリロードすると一つ前のバージョンが表示されるか（ロールバックの確認）。
