# 非公開コンテンツ共有用構成メモ

## 背景と目的

- 一部の関係者にだけMarkdown形式の資料と画像を共有したい。
- 現状はローカルにGit管理外のmdと画像を置き、手動でビルドしてBasic認証ページで公開している。
- Git連携ができず、CI/CD運用できないのが不便。
- 画像の直リンクや保存もできれば防ぎたい。

## 要件

- Git連携による自動デプロイを実現したい。
- 非公開資料はMarkdownで記述し、画像とともにCloudflare上に安全に保存したい。
- 閲覧にはBasic認証を使い、URLが漏れてもアクセスできないようにしたい。
- ブラウザから画像を直接保存・ダウンロードされにくい構成にしたい。

## 採用する構成

### 保存先

- Markdown・画像は Cloudflare R2 に保存
- R2バケットは public にせず、アクセス制御を Workers 経由で行う
- アップロードは手動（Wrangler CLI または R2 ダッシュボード）

### 公開方法

- Git にテンプレートコードは含め、R2のコンテンツは含めない
- Next.js (OpenNext) + Cloudflare Workers で秘匿ページを動的生成
- Basic認証によってページ全体を保護

### 画像表示の扱い

- R2の画像には直接アクセスできないようにする（privateバケット）
- Next.js 経由で `/api/proxy-image?path=...` などのプロキシを実装
- プロキシAPI側で Referer チェック等により外部からの直アクセスを制限
- `<img>` タグには以下の抑止を実装
  - `draggable="false"`
  - `onContextMenu={e => e.preventDefault()}`

### PDF化について

- 現時点ではPDF化は対応しない（構成がmd→tsxのため、実装コストが高い）
- 将来的に、必要な資料だけ puppeteer などを使ってPDF化する可能性は残す

## 懸念と対応

| 懸念点                          | 対応策                                              |
|----------------------------------|------------------------------------------------------|
| Gitに含まれていないためCIができない | コンテンツをR2に分離し、コードのみをGit管理         |
| ローカルからの手動デプロイが手間 | GitHub連携で自動ビルド＆デプロイ可能に              |
| 画像URLが直アクセス可能になる   | Workers経由のプロキシを導入し、R2は非公開バケットに |
| 閲覧ページから画像を保存される   | ドラッグ・右クリック禁止の簡易抑止を実装            |
| 完全なダウンロード防止は不可     | ブラウザの制約上、構造的に不可能。抑止にとどめる    |

## 今後のステップ（実装順）

1. R2バケット作成（private設定）
2. Markdown・画像をアップロード（手動）
3. `/api/proxy-image` 実装
4. Basic認証付きの秘匿ページに組み込み
5. GitHub連携によるデプロイフロー確認
